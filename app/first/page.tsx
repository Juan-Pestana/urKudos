//import {useState} from 'react'

import Head from 'next/head'
import PocketBase from 'pocketbase'
import { cookies } from 'next/headers'
import Posts from '../../components/first/(components)/Posts'
import PostInput from '../../components/first/(components)/PostInput'
import { redirect } from 'next/navigation'

import StoreInitializer from '../StoreInitializer'

export const dynamic = 'auto',
  dynamicParams = true,
  revalidate = 0,
  fetchCache = 'auto',
  runtime = 'nodejs'

async function initPocketBase() {
  const pb = new PocketBase('http://127.0.0.1:8090')

  // load the store data from the request cookie string
  const pbauthData = cookies().get('pb_auth')?.value || ''

  await pb.authStore.loadFromCookie(pbauthData)

  // send back the default 'pb_auth' cookie to the client with the latest store state
  // pb.authStore.onChange(() => {
  //   cookies().set('pb_auth', pb.authStore.exportToCookie())

  // })

  try {
    // get an up-to-date auth store state by verifying and refreshing the loaded auth model (if any)
    pb.authStore.isValid && (await pb.collection('users').authRefresh())
  } catch (_) {
    // clear the auth store on failed refresh

    pb.authStore.clear()
  }

  return pb
}

const getComments = async (id: string) => {
  const pb = await initPocketBase()
  const records = await pb.collection('comments').getList(1, 50, {
    filter: `post = "${id}"`,
    expand: 'user',
  })
  return records as any
}

const getPosts = async () => {
  const pb = await initPocketBase()

  //console.log(userString)

  const records: any = await pb
    .collection('posts')
    .getFullList(200, { expand: 'image,owner', sort: '-created' })

  // const comments = await getComments(records[0].id)

  // console.log(comments)

  if (!records || !records.length) {
    redirect('/')
  } else {
    const posts = await Promise.all(
      records.map(async (post: any) => {
        // const comments = await getComments(post.id)

        return {
          id: post.id,
          owner: {
            name: post.expand.owner.name,
            avatar: post.expand.owner.avatar,
            position: post.expand.owner.department,
            id: post.expand.owner.id,
          },
          content: {
            text: post.text,
            image: post.expand.image
              ? {
                  imgName: post.expand.image.image,
                  imgId: post.expand.image.id,
                }
              : undefined,
            video: post.video,
            link: post.link,
          },

          likes: [2, 3, 4, 5, 6, 7, 8, 10],
          comments: [],
        }
      })
    )
    if (posts) {
      return posts
    } else {
      return {
        posts: [],
      }
    }
  }
}

export default async function FirstPage() {
  const posts = await getPosts()

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <StoreInitializer posts={posts} />
      <section className="flex flex-col justify-center sm:w-3/4  lg:w-1/2 xl:w-2/6 mx-auto py-3">
        <PostInput />

        {posts && <Posts />}
      </section>
    </>
  )
}
